name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

jobs:
  # ============================================
  # Detect Changes Job
  # ============================================
  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      api_changed: ${{ steps.detect.outputs.api_changed || 'false' }}
      admin_changed: ${{ steps.detect.outputs.admin_changed || 'false' }}
      web_changed: ${{ steps.detect.outputs.web_changed || 'false' }}
      shared_changed: ${{ steps.detect.outputs.shared_changed || 'false' }}
      root_changed: ${{ steps.detect.outputs.root_changed || 'false' }}
      skip_build: ${{ steps.detect.outputs.skip_build || 'false' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed apps
        id: detect
        run: |
          chmod +x .github/workflows/detect-changes.sh
          .github/workflows/detect-changes.sh
        env:
          BASE_COMMIT: ${{ github.event.before || 'HEAD~1' }}
          CURRENT_COMMIT: ${{ github.sha }}

  # ============================================
  # Quality Checks Job
  # ============================================
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Check code formatting
        run: pnpm format:check

      - name: Run linting
        run: pnpm lint

      - name: Run type checking
        run: pnpm typecheck

  # ============================================
  # Test Job
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Run tests
        run: pnpm test

  # ============================================
  # Build Job (Conditional - only builds changed apps)
  # ============================================
  build:
    name: Build Changed Apps
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect-changes, quality-checks, test]
    if: needs.detect-changes.outputs.skip_build != 'true'
    outputs:
      api_built: ${{ steps.build-api.outputs.built || 'false' }}
      admin_built: ${{ steps.build-admin.outputs.built || 'false' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Build API (if changed)
        id: build-api
        run: |
          if [ "${{ needs.detect-changes.outputs.api_changed }}" = "true" ]; then
            echo "ğŸ”¨ Building API..."
            pnpm --filter @raverpay/raverpay-api build
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipping API build (no changes detected)"
            echo "built=false" >> $GITHUB_OUTPUT
          fi
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          JWT_SECRET: "dummy-jwt-secret-for-build"
          JWT_REFRESH_SECRET: "dummy-jwt-refresh-secret-for-build"
        continue-on-error: false

      - name: Build Admin (if changed)
        id: build-admin
        run: |
          if [ "${{ needs.detect-changes.outputs.admin_changed }}" = "true" ]; then
            echo "ğŸ”¨ Building Admin..."
            pnpm --filter @raverpay/raverpay-admin build
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipping Admin build (no changes detected)"
            echo "built=false" >> $GITHUB_OUTPUT
          fi
        env:
          NEXT_PUBLIC_API_URL: "https://api.raverpay.com"
        continue-on-error: false

      - name: Build Web (if changed)
        if: needs.detect-changes.outputs.web_changed == 'true'
        run: |
          echo "ğŸ”¨ Building Web..."
          pnpm --filter @raverpay/raverpay-web build
        env:
          NEXT_PUBLIC_API_URL: "https://api.raverpay.com"
        continue-on-error: false

      - name: Build Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Build Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "API built:   ${{ steps.build-api.outputs.built || 'false' }}"
          echo "Admin built: ${{ steps.build-admin.outputs.built || 'false' }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================
  # Security Scan Job
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: pnpm audit --audit-level=critical
        continue-on-error: true

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --since-commit HEAD~1
        continue-on-error: true

  # ============================================
  # Deploy to Railway (Only on push to main, conditional)
  # ============================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, build, security-scan]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.skip_build != 'true'
    outputs:
      api_deployed: ${{ steps.deploy-api.outputs.deployed || 'false' }}
      admin_deployed: ${{ steps.deploy-admin.outputs.deployed || 'false' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy raverpay-api to Railway
        id: deploy-api
        run: |
          if [ "${{ needs.detect-changes.outputs.api_changed }}" = "true" ]; then
            echo "ğŸš€ Deploying API to Railway..."
            railway up --service @raverpay/raverpay-api --detach
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipping API deployment (no changes detected)"
            echo "deployed=false" >> $GITHUB_OUTPUT
          fi
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: false

      - name: Deploy raverpay-admin to Railway
        id: deploy-admin
        run: |
          if [ "${{ needs.detect-changes.outputs.admin_changed }}" = "true" ]; then
            echo "ğŸš€ Deploying Admin to Railway..."
            railway up --service @raverpay/raverpay-admin --detach
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipping Admin deployment (no changes detected)"
            echo "deployed=false" >> $GITHUB_OUTPUT
          fi
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: false

      - name: Wait for deployments to complete
        if: |
          steps.deploy-api.outputs.deployed == 'true' ||
          steps.deploy-admin.outputs.deployed == 'true'
        run: sleep 120

      - name: Health check (API)
        if: steps.deploy-api.outputs.deployed == 'true'
        run: |
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts"
            
            response=$(curl -s -o /dev/null -w "%{http_code}" https://api.raverpay.com/api/health || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            
            echo "âŒ Health check failed (HTTP $response). Retrying in 20 seconds..."
            sleep 20
            attempt=$((attempt + 1))
          done
          
          echo "âŒ Health check failed after $max_attempts attempts"
          exit 1

      - name: Verify admin deployment
        if: steps.deploy-admin.outputs.deployed == 'true'
        run: |
          max_attempts=5
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Admin check attempt $attempt/$max_attempts"
            
            # Check if admin is responding (Next.js apps typically return 200 on root)
            response=$(curl -s -o /dev/null -w "%{http_code}" https://myadmin.raverpay.com || echo "000")
            
            if [ "$response" = "200" ] || [ "$response" = "302" ] || [ "$response" = "404" ]; then
              echo "âœ… Admin deployment is live (HTTP $response)"
              exit 0
            fi
            
            echo "â³ Admin not ready yet (HTTP $response). Retrying in 15 seconds..."
            sleep 15
            attempt=$((attempt + 1))
          done
          
          echo "âš ï¸ Admin deployment check completed (may still be deploying)"
        continue-on-error: true

      - name: Run smoke tests
        if: steps.deploy-api.outputs.deployed == 'true'
        run: |
          chmod +x .github/workflows/smoke-tests.sh
          .github/workflows/smoke-tests.sh
        env:
          API_URL: https://api.raverpay.com
          SMOKE_TEST_EMAIL: ${{ secrets.SMOKE_TEST_EMAIL }}
          SMOKE_TEST_PASSWORD: ${{ secrets.SMOKE_TEST_PASSWORD }}
        continue-on-error: false

      - name: Deployment Summary
        run: |
          API_DEPLOYED="${{ steps.deploy-api.outputs.deployed }}"
          ADMIN_DEPLOYED="${{ steps.deploy-admin.outputs.deployed }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "API deployed:   $API_DEPLOYED"
          echo "Admin deployed: $ADMIN_DEPLOYED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$API_DEPLOYED" != "true" ] && [ "$ADMIN_DEPLOYED" != "true" ]; then
            echo "â„¹ï¸ No deployments were needed (no changes detected)"
          fi

  # ============================================
  # Notify Job (runs on success or failure)
  # ============================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send success email via Resend
        if: needs.deploy.result == 'success'
        run: |
          chmod +x .github/workflows/send-resend-email.sh
          
          # Build deployment list
          DEPLOYMENTS=""
          if [ "${{ needs.deploy.outputs.api_deployed }}" = "true" ]; then
            DEPLOYMENTS="${DEPLOYMENTS}- API: https://api.raverpay.com\n"
          fi
          if [ "${{ needs.deploy.outputs.admin_deployed }}" = "true" ]; then
            DEPLOYMENTS="${DEPLOYMENTS}- Admin: https://myadmin.raverpay.com\n"
          fi
          
          .github/workflows/send-resend-email.sh \
            "âœ… RaverPay Deployment Successful - ${{ github.sha }}" \
            "Deployment to Railway completed successfully!

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          Message: ${{ github.event.head_commit.message }}

          Deployed Services:
          ${DEPLOYMENTS}
          
          View commit: ${{ github.event.head_commit.url }}" \
            "raverpay@outlook.com"
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        continue-on-error: true

      - name: Send failure email via Resend
        if: needs.deploy.result == 'failure'
        run: |
          chmod +x .github/workflows/send-resend-email.sh
          .github/workflows/send-resend-email.sh \
            "âŒ RaverPay Deployment Failed - ${{ github.sha }}" \
            "âš ï¸ Deployment to Railway FAILED!

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          Message: ${{ github.event.head_commit.message }}

          Please check the GitHub Actions logs:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            "raverpay@outlook.com"
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        continue-on-error: true

